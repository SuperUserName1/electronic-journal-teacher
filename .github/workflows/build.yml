name: Build Windows Release

on:
  push:
    tags:
      - v*
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Install build tools
        run: |
          # Устанавливаем только необходимое
          npm install -g windows-build-tools
          # Или используем существующие инструменты в Windows runner
          # Проверяем, что есть необходимые компиляторы
          cl.exe 2>&1 || echo "Visual Studio tools might not be fully available"
        shell: powershell
        
      - name: Configure npm for Electron build
        run: |
          # Устанавливаем переменные окружения для сборки нативных модулей
          npm config set target 27.3.11
          npm config set arch x64
          npm config set target_arch x64
          npm config set runtime electron
          npm config set disturl https://electronjs.org/headers
          npm config set build_from_source true
          
          # Для работы sqlite3 устанавливаем дополнительные флаги
          npm config set sqlite3_binary_host_mirror https://github.com/TryGhost/node-sqlite3/releases/download
        shell: powershell
        
      - name: Install dependencies
        run: |
          npm ci --verbose
          # Устанавливаем electron-builder глобально для упрощения
          npm install -g electron-builder@24
        shell: powershell
        
      - name: Build renderer
        run: npm run build
        
      - name: Package Electron app
        run: |
          # Пробуем использовать более простой подход
          npx electron-builder build --win --x64 --config.win.target=nsis --config.asar=true
          # ИЛИ если не работает, попробуйте:
          # npx electron-builder --win --x64
        shell: powershell
        
      - name: List artifacts
        run: |
          Write-Host "Looking for build artifacts..."
          if (Test-Path "dist") {
            Get-ChildItem "dist" -Recurse
          } else {
            Write-Host "dist folder not found, checking other locations..."
            Get-ChildItem -Recurse -Filter "*.exe" | Select-Object FullName
          }
        shell: powershell
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/*.exe
            dist/*.msi
            dist/*.nsis.exe
          if-no-files-found: warn