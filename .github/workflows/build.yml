
name: Build Windows Release

on:
  push:
    tags:
      - v*
  workflow_dispatch:  # Позволяет запускать вручную из GitHub UI

jobs:
  build-windows:
    runs-on: windows-latest
    
    # Устанавливаем необходимые зависимости Windows для сборки нативных модулей
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          
      - name: Install Visual Studio Build Tools
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '17.10'
          
      - name: Add MSBuild to PATH
        run: echo "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin" >> $GITHUB_PATH
        
      - name: Install Windows SDK
        run: |
          choco install windows-sdk-10-version-22h2-all-noarch -y
          choco install vcredist-all -y
          
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund
        
      - name: Rebuild sqlite3 for Electron
        run: |
          npm rebuild sqlite3 --runtime=electron --target=27.3.11 --disturl=https://artifacts.electronjs.org/headers/dist/  --abi=115
        env:
          npm_config_arch: x64
          
      - name: Build application
        run: npm run build
        
      - name: Package application (Installer)
        run: npm run package-win-installer
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Package application (Portable)
        run: npm run package-win-portable
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/*.exe